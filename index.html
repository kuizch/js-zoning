<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Manitoba Zoning</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <!-- ArcGIS CSS & JS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">

    <script src="https://js.arcgis.com/4.33"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-size: 150%;
        }
        /* Give the map a visible size */
        #viewDiv {
            height: 100vh;
            width: 100vw;
        }
    </style>

    <script>
        // Ensure the DOM is parsed before querying elements
        window.addEventListener('DOMContentLoaded', () => {
            require([
                "esri/identity/OAuthInfo",
                "esri/identity/IdentityManager",
                "esri/Map",
                "esri/views/MapView",
                "esri/layers/FeatureLayer"
            ], function (OAuthInfo, esriId, Map, MapView, FeatureLayer) {

                // --- OAuth setup ---
                const portalUrl = "https://www.arcgis.com";
                const info = new OAuthInfo({
                    appId: "dSrIbXNY8sp0Rhjw", // <-- put your Client ID here
                    portalUrl,
                    popup: false // use popup-based OAuth (recommended for simple apps)
                });

                esriId.registerOAuthInfos([info]);

                let view = null; // keep a reference so we can clean up
                const portalSharing = `${portalUrl}/sharing`;


                function initMap() {
                    const map = new Map({ basemap: "arcgis/topographic" });

                    view = new MapView({
                        map,
                        container: "viewDiv",
                        center: [-97.1384, 49.8951], // Winnipeg [lon, lat]
                        zoom: 10
                    });

                    const featureLayer = new FeatureLayer({
                        url: "https://services.arcgis.com/mMUesHYPkXjaFGfS/arcgis/rest/services/Manitoba_Zoning_By_Laws/FeatureServer/0"
                    });

                    map.add(featureLayer);
                }

                // Auto-auth flow:
                // 1) If already signed in, init map.
                // 2) If not, prompt sign-in and then init map.
                esriId.checkSignInStatus(portalSharing)
                    .then(initMap)
                    .catch(() => {
                        esriId.getCredential(portalSharing)
                            .then(initMap)
                            .catch(() => {
                                // User canceled login; you could show a message or fallback UI here.
                                console.warn("User canceled sign-in.");
                            });
                    });

                // Optional: support a developer-only "logout" via URL, e.g., ?logout=1
                const params = new URLSearchParams(location.search);
                if (params.has("logout")) {
                    esriId.destroyCredentials();
                    // Clean querystring and reload
                    const cleanUrl = location.origin + location.pathname + location.hash;
                    location.replace(cleanUrl);
                }
            });
        });
    </script>
</head>
<body>
    <div id="viewDiv"></div>
</body>
</html>
