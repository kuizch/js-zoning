<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Manitoba Zoning</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

    <!-- ArcGIS CSS & JS -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.33/esri/themes/light/main.css">

    <script src="https://js.arcgis.com/4.33"></script>

    <style>
        html, body {
            height: 100%;
            margin: 0;
            font-size: 150%;
        }
        /* Give the map a visible size */
        #viewDiv {
            height: 80vh;
            width: 80vw;
            margin: 10vh 10vw;
            position: relative;
        }

        button {
            position: absolute;
            left: 15px;
            z-index: 20;
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        #sign-in {
            top: 15px;
        }

        #sign-out {
            top: 50px;
        }
    </style>

    <script>
        require([
            "esri/identity/OAuthInfo",
            "esri/identity/IdentityManager",
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer"
        ], function (OAuthInfo, esriId, Map, MapView, FeatureLayer) {

            // --- OAuth setup ---
            const info = new OAuthInfo({
                appId: "dSrIbXNY8sp0Rhjw", // <-- put your Client ID here
                // portalUrl: "https://www.arcgis.com", // optional; defaults to ArcGIS Online
                popup: true // use popup-based OAuth (recommended for simple apps)
            });

            esriId.registerOAuthInfos([info]);

            let view = null; // keep a reference so we can clean up

            // Signed-in: build the map
            function handleSignedIn() {
                const map = new Map({ basemap: "arcgis/topographic" });

                view = new MapView({
                    map,
                    container: "viewDiv",
                    center: [-97.1384, 49.8951], // Winnipeg [lon, lat]
                    zoom: 10
                });

                const featureLayer = new FeatureLayer({
                    url: "https://services.arcgis.com/mMUesHYPkXjaFGfS/arcgis/rest/services/Manitoba_Zoning_By_Laws/FeatureServer/0"
                });

                map.add(featureLayer);
            }

            // Signed-out: remove credentials and clear the view if needed
            function handleSignedOut() {
                if (view) {
                    view.destroy();
                    view = null;
                }
            }

            // Check if already signed in
            esriId
                .checkSignInStatus((info.portalUrl || "https://www.arcgis.com") + "/sharing")
                .then(handleSignedIn)
                .catch(handleSignedOut);

            // Buttons
            document.getElementById("sign-in").addEventListener("click", function () {
                esriId.getCredential((info.portalUrl || "https://www.arcgis.com") + "/sharing")
                    .then(handleSignedIn)
                    .catch(() => {/* user may cancel; no-op */ });
            });

            document.getElementById("sign-out").addEventListener("click", function () {
                esriId.destroyCredentials();
                handleSignedOut();
                // Optional: force a clean reload to reset app state
                window.location.reload();
            });

        });
    </script>
</head>
<body>
    <div id="viewDiv">
        <button id="sign-in" class="btn btn-primary">Sign In</button>
        <button id="sign-out" class="btn btn-primary">Sign Out</button>
    </div>
</body>
</html>

